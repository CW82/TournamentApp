<table border="1">
    <thead>
        <tr>
            <th>matchID</th>
            <th>tournamentID</th>
            <th>scheduledTime</th>
            <th>winner</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {{#each matches}}
        <tr data-matchid="{{matchID}}">
            <td>{{matchID}}</td>
            <td class="tournamentID">{{tournamentID}}</td>
            <td class="scheduledTime">{{scheduledTime}}</td>
            <td class="winner">{{winner}}</td>
            <td>
                <div class="action-buttons">
                    <button class="edit-btn">Edit</button>
                    <form method="POST" class="delete-button" action="/matches/delete/{{matchID}}" style="display:inline">
                        <button type="submit" onclick="return confirmDelete('Match {{matchID}}')">Delete</button>
                    </form>
                </div>
            </td>
        </tr>
        {{/each}}
    </tbody>
</table>

<form action="/matches/add" method="POST" class="add-form">
    <h3>Add New Match</h3>
    <div class="form-row">
        <select name="tournamentID" required>
            <option value="" disabled selected>Select tournament</option>
            {{#each tournaments}}
                <option value="{{tournamentID}}">{{tournamentName}} (ID: {{tournamentID}})</option>
            {{/each}}
        </select>
        <input type="datetime-local" name="scheduledTime" required>
        <input type="text" name="winner" placeholder="Winner">
        <button type="submit">Add Match</button>
    </div>
</form>

<!-- options template used by the client-side edit form -->
<script id="tournament-options" type="text/template">
    {{#each tournaments}}
        <option value="{{tournamentID}}">{{tournamentName}} (ID: {{tournamentID}})</option>
    {{/each}}
</script>

<script>
function confirmDelete(name) {
    return confirm(`Are you sure you want to delete "${name}"?`);
}

document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const row = btn.closest('tr');
            const id = row.dataset.matchid;

            if (row.querySelector('input')) return;

            const tournamentID = row.querySelector('.tournamentID').textContent;
            const scheduledTime = row.querySelector('.scheduledTime').textContent;
            const winner = row.querySelector('.winner').textContent;

            // Replace tournamentID cell with a select populated from the server-rendered options
            const optionsHtml = document.getElementById('tournament-options').innerHTML;
            row.querySelector('.tournamentID').innerHTML = `<select name="tournamentID">${optionsHtml}</select>`;
            // set currently-selected value
            const select = row.querySelector('select[name="tournamentID"]');
            if (select) select.value = tournamentID.trim();

            row.querySelector('.scheduledTime').innerHTML = `<input type="datetime-local" name="scheduledTime" value="${scheduledTime}">`;
            row.querySelector('.winner').innerHTML = `<input type="text" name="winner" value="${winner}">`;

            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'Save';
            saveBtn.type = 'button';
            btn.replaceWith(saveBtn);

            saveBtn.addEventListener('click', async () => {
                const data = new URLSearchParams();
                data.append('tournamentID', row.querySelector('[name="tournamentID"]').value);
                data.append('scheduledTime', row.querySelector('[name="scheduledTime"]').value);
                data.append('winner', row.querySelector('[name="winner"]').value);

                const response = await fetch(`/matches/update/${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: data.toString()
                });

                if (response.ok) window.location.reload();
                else alert('Error updating match');
            });
        });
    });
});
</script>

<script>
// Fallback: if the server-rendered select has no options (other than placeholder), fetch tournaments
document.addEventListener('DOMContentLoaded', () => {
    const addSelect = document.querySelector('form.add-form select[name="tournamentID"]');
    const templateTag = document.getElementById('tournament-options');
    if (addSelect && addSelect.options.length <= 1) {
        fetch('/api/tournaments')
            .then(r => r.json())
            .then(data => {
                data.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t.tournamentID;
                    opt.textContent = `${t.tournamentName} (ID: ${t.tournamentID})`;
                    addSelect.appendChild(opt);
                });

                // also populate the client-side template used for inline edits
                if (templateTag) {
                    templateTag.innerHTML = data.map(t => `<option value="${t.tournamentID}">${t.tournamentName} (ID: ${t.tournamentID})</option>`).join('');
                }
            })
            .catch(err => console.error('Failed to load tournaments for select:', err));
    }
});
</script>
